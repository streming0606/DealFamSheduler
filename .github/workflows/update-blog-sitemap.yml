name: Update Blog Sitemap

# Trigger when posts.json is modified
on:
  push:
    paths:
      - 'blog/data/posts.json'
    branches:
      - main

# Also allow manual trigger from Actions tab
  workflow_dispatch:

jobs:
  update-sitemap:
    runs-on: ubuntu-latest
    
    steps:
      # Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # Run sitemap generation script
      - name: Generate Blog Sitemap
        run: node blog/generate-sitemap.js

      # Check if sitemap.xml changed
      - name: Check if sitemap changed
        id: sitemap-changed
        run: |
          if git diff --quiet blog/sitemap.xml; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # Commit and push changes (if sitemap changed)
      - name: Commit and push sitemap
        if: steps.sitemap-changed.outputs.changed == 'true'
        run: |
          git config user.name "Blog Sitemap Bot"
          git config user.email "bot@thriftmaal.local"
          git add blog/sitemap.xml
          git commit -m "ü§ñ Auto-update blog sitemap from posts.json"
          git push

      # Log result
      - name: Log result
        run: |
          if [ "${{ steps.sitemap-changed.outputs.changed }}" = "true" ]; then
            echo "‚úÖ Sitemap updated and committed"
          else
            echo "‚ÑπÔ∏è Sitemap already up-to-date, no changes needed"
          fi

      # (Optional) Notify Slack on failure
      - name: Notify Slack on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "‚ùå Blog Sitemap Update Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Blog Sitemap Generation Failed*\nRepo: ${{ github.repository }}\nBranch: ${{ github.ref }}\nCommit: ${{ github.sha }}"
                  }
                }
              ]
            }
