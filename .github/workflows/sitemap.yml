name: Generate Sitemap

# Trigger: Runs on every push to main branch or manual trigger
on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sitemap_job:
    runs-on: ubuntu-latest
    name: Generate and update sitemap

    steps:
    # Step 1: Checkout repository with full history
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    # Step 2: Generate sitemap automatically
    - name: Generate sitemap
      id: sitemap
      uses: cicirello/generate-sitemap@v1
      with:
        base-url-path: https://thriftmaal.com/
        path-to-root: .
        include-html: true
        include-pdf: false
        drop-html-extension: true

    # Step 3: Show statistics in Actions log
    - name: Output sitemap statistics
      run: |
        echo "✅ Sitemap generated successfully!"
        echo "📍 Sitemap path: ${{ steps.sitemap.outputs.sitemap-path }}"
        echo "📄 Total URLs: ${{ steps.sitemap.outputs.url-count }}"
        echo "🚫 Excluded: ${{ steps.sitemap.outputs.excluded-count }}"

    # Step 4: Commit and push sitemap to repository
    - name: Commit and push sitemap
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git add sitemap.xml
        if git diff --staged --quiet; then
          echo "No changes to sitemap"
        else
          git commit -m "🤖 Auto-update sitemap [skip ci]"
          git push
        fi
